<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ETF çŒæ‰‹ | è°ƒè¯•ç‰ˆ</title>
    <!-- 1. å¼•å…¥æ ·å¼åº“ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { gray: { 850: '#1f2937', 900: '#111827', 950: '#030712' } }
                }
            }
        }
    </script>
    <!-- 2. å¼•å…¥ Vue å’Œ Supabase -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        [v-cloak] { display: none; } /* é˜²æ­¢VueæœªåŠ è½½æ—¶é—ªçƒ */
    </style>
</head>
<body class="bg-gray-950 text-gray-100 font-sans antialiased min-h-screen pb-10">

<!-- æŒ‚è½½ç‚¹ï¼šVueåº”ç”¨ä»è¿™é‡Œå¼€å§‹æ¸²æŸ“ -->
<div id="app" v-cloak class="max-w-md mx-auto bg-gray-900 min-h-screen shadow-2xl relative border-x border-gray-800">
    
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="sticky top-0 z-50 bg-gray-900/95 backdrop-blur border-b border-gray-800 p-4">
        <h1 class="text-xl font-black italic tracking-tighter bg-gradient-to-r from-indigo-400 to-cyan-400 bg-clip-text text-transparent">
            ETF HUNTER
        </h1>
        <!-- æœç´¢æ¡† -->
        <div class="mt-4 relative">
            <input v-model="searchQuery" type="text" placeholder="æœä»£ç /åç§°..." 
                   class="w-full bg-gray-800 text-white border border-gray-700 rounded-lg py-2.5 px-4 focus:outline-none focus:border-indigo-500 text-sm">
        </div>
    </header>

    <!-- çŠ¶æ€æç¤ºåŒº -->
    <div v-if="loading" class="text-center py-10 text-gray-500 animate-pulse">
        æ­£åœ¨è¿æ¥æ•°æ®åº“...
    </div>
    
    <div v-if="errorMsg" class="p-4 m-4 bg-red-900/30 border border-red-500/50 text-red-200 text-xs rounded">
        âŒ é”™è¯¯: {{ errorMsg }}
        <br>è¯·æ£€æŸ¥ä½ çš„ index.html é‡Œæ˜¯å¦å¡«äº†æ­£ç¡®çš„ URL å’Œ KEYã€‚
    </div>

    <!-- åˆ—è¡¨åŒº -->
    <div v-if="!loading" class="p-4 space-y-4">
        
        <!-- å¡ç‰‡å¾ªç¯ -->
        <div v-for="item in filteredList" :key="item.code" class="bg-gray-800 rounded-xl border border-gray-700/50 shadow-lg overflow-hidden p-4">
            <div class="flex justify-between items-start">
                <div>
                    <div class="font-bold text-lg">{{ item.name }} <span class="text-xs font-normal text-gray-500">({{ item.code }})</span></div>
                    <div class="text-xs mt-1 px-2 py-0.5 rounded inline-block" 
                         :class="item.type === 'cross' ? 'bg-purple-500/10 text-purple-400' : 'bg-blue-500/10 text-blue-400'">
                        {{ item.type === 'cross' ? 'è·¨å¢ƒ QDII' : 'æœ¬åœŸ Aè‚¡' }}
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xl font-mono">{{ item.price }}</div>
                </div>
            </div>

            <!-- æ•°æ®å±•ç¤ºåŒº -->
            <div class="mt-3 pt-3 border-t border-gray-700/30 text-sm space-y-1">
                <div v-if="item.type === 'cross'" class="flex justify-between">
                    <span class="text-gray-400">æº¢ä»·ç‡:</span>
                    <span :class="item.premium_rate > 0 ? 'text-red-400' : 'text-green-400'">{{ item.premium_rate }}%</span>
                </div>
                <div v-if="item.type === 'cross'" class="flex justify-between">
                    <span class="text-gray-400">çŠ¶æ€:</span>
                    <span :class="item.quota_status === 'closed' ? 'text-red-400' : 'text-green-400'">
                        {{ item.quota_status === 'closed' ? 'æš‚åœç”³è´­' : 'å¼€æ”¾' }}
                    </span>
                </div>
            </div>
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div v-if="filteredList.length === 0 && !errorMsg" class="text-center py-10 text-gray-600 text-sm">
            æ•°æ®åº“é‡Œæ²¡æœ‰æ‰¾åˆ°æ•°æ®<br>è¯·å» Supabase æ’å…¥ä¸€æ¡æ•°æ®è¯•è¯•
        </div>

    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue

    createApp({
        setup() {
            // =================================================
            // ğŸ”¥ è¯·åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ Supabase å¯†é’¥ (ä¿ç•™å¼•å·)
            // =================================================
            const SUPABASE_URL = 'https://wrlhrwqhxomfjepvzfai.supabase.co' 
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndybGhyd3FoeG9tZmplcHZ6ZmFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1MjIyNjIsImV4cCI6MjA4MTA5ODI2Mn0.moNJty0hBJrxXK6j_DfI-hyCuWvLT5xg39tDZb1iLbs'
            // =================================================

            const searchQuery = ref('')
            const assets = ref([])
            const loading = ref(true)
            const errorMsg = ref('')

            // 1. å®‰å…¨åœ°åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
            let supabaseClient = null
            try {
                if (window.supabase) {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
                } else {
                    throw new Error('Supabase åº“åŠ è½½å¤±è´¥')
                }
            } catch (err) {
                errorMsg.value = 'Supabase åˆå§‹åŒ–å¤±è´¥: ' + err.message
                loading.value = false
            }

            // 2. æ‹‰å–æ•°æ®å‡½æ•°
            const fetchData = async () => {
                // å¦‚æœå¯†é’¥è¿˜æ²¡å¡«ï¼Œç›´æ¥æŠ¥é”™æé†’
                if (SUPABASE_URL.includes('https://wrlhrwqhxomfjepvzfai.supabase.co')) {
                    errorMsg.value = 'ä½ è¿˜æ²¡æœ‰åœ¨ä»£ç é‡Œå¡«å…¥ Supabase URL å’Œ KEYï¼'
                    loading.value = false
                    return
                }

                try {
                    const { data, error } = await supabaseClient
                        .from('etf_assets')
                        .select('*')
                    
                    if (error) throw error
                    
                    assets.value = data || []
                    console.log('æ•°æ®åŠ è½½æˆåŠŸ:', data)
                } catch (err) {
                    console.error(err)
                    errorMsg.value = 'è¯»å–æ•°æ®åº“å¤±è´¥: ' + err.message
                } finally {
                    loading.value = false
                }
            }

            // 3. æŒ‚è½½æ—¶è¿è¡Œ
            onMounted(() => {
                if (!errorMsg.value) {
                    fetchData()
                }
            })

            // æœç´¢è¿‡æ»¤
            const filteredList = computed(() => {
                if (!searchQuery.value) return assets.value;
                const q = searchQuery.value.toLowerCase();
                return assets.value.filter(item => 
                    (item.name && item.name.toLowerCase().includes(q)) || 
                    (item.code && item.code.includes(q))
                )
            })

            return {
                searchQuery,
                filteredList,
                loading,
                errorMsg
            }
        }
    }).mount('#app')
</script>

</body>
</html>